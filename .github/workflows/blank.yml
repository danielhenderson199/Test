name: Windows AnyDesk Setup with Chocolatey (cmd)

on:
  workflow_dispatch:

jobs:
  setup:
    runs-on: windows-latest

    steps:
      - name: Install Chocolatey (if missing)
        run: |
          where choco || (
            @powershell -NoProfile -InputFormat None -ExecutionPolicy Bypass -Command ^
              "Set-ExecutionPolicy Bypass -Scope Process -Force; iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))"
          )
        shell: cmd

      - name: Install AnyDesk with Chocolatey
        run: choco install anydesk -y
        shell: cmd

      - name: Set AnyDesk Password (PowerShell helper)
        run: powershell -Command ^
          "$RegPath = 'HKLM:\\SOFTWARE\\AnyDesk'; ^
          if (-not (Test-Path $RegPath)) { New-Item -Path $RegPath -Force | Out-Null }; ^
          $Password = 'DANIEL64MACOSVM'; ^
          $PasswordBytes = [System.Text.Encoding]::UTF8.GetBytes($Password); ^
          Set-ItemProperty -Path $RegPath -Name 'Password' -Value $PasswordBytes -Type Binary"
        shell: cmd

      - name: Launch AnyDesk
        run: |
          if exist "C:\Program Files (x86)\AnyDesk\AnyDesk.exe" (
            start "" "C:\Program Files (x86)\AnyDesk\AnyDesk.exe"
          ) else if exist "C:\Program Files\AnyDesk\AnyDesk.exe" (
            start "" "C:\Program Files\AnyDesk\AnyDesk.exe"
          ) else (
            echo AnyDesk executable not found.
            exit /b 1
          )
        shell: cmd

      - name: Keep runner alive
        run: |
          :loop
          echo Still running...
          timeout /t 60 /nobreak > nul
          goto loop
        shell: cmd
